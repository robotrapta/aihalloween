<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Halloween</title>
    <style>
        body {
            background-color: #8B4500; /* Very dark orange */
            color: white;
            text-align: center;
        }
        #gallery {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .image-container {
            margin: 10px;
            max-width: 400px;
            flex: 1 1 300px; /* Flex-grow, flex-shrink, flex-basis */
            border: 1px solid #444; /* Subtle border color */
            background-color: #222; /* Dark background color */
            padding: 15px; /* Padding for spacing */
            box-sizing: border-box; /* Ensures padding and border are included in the element's total width and height */
            border-radius: 8px; /* Rounded corners */
            transition: transform 0.3s; /* Smooth transition for hover effect */
        }
        .image-container:hover {
            transform: scale(1.05); /* Slight zoom effect on hover */
        }
        img {
            max-width: 100%;
            height: auto;
            border-radius: 5px; /* Slightly rounded corners for images */
        }
        .image-title {
            margin-top: 10px;
            font-size: 1.2em;
        }
        .timestamp {
            font-size: 0.9em;
            color: #ccc;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script>
        dayjs.extend(dayjs_plugin_relativeTime);

        $(document).ready(function() {
            const images = [
                { order: 1, src: "media/latest-triggered.jpg", alt: "Latest Triggered", title: "Latest Triggered" },
                { order: 2, src: "media/latest-person.jpg", alt: "Latest Person", title: "Latest Person Detected" },
                { order: 3, src: "media/latest-motion.jpg", alt: "Latest Motion", title: "Latest Motion Detected" },
                { order: 4, src: "media/first-frame.jpg", alt: "First Frame", title: "System boot frame" }
            ];

            const imageTimestamps = []; // Array to store timestamps

            function getRelativeTime(created) {
                return created ? dayjs(created).fromNow() : 'No timestamp available';
            }

            function updateImageContainer(index, image, data) {
                const relativeTime = getRelativeTime(data ? data.created : null);
                const triggeredBy = (image.title === "Latest Triggered" && data) ? data.triggered_by : null;
                const container = $(`#image-container-${index}`);

                // Use the image's last updated timestamp for cache busting
                const cacheBustedSrc = `${image.src}?timestamp=${data ? data.created : new Date().getTime()}`;

                // Re-render the entire container if the timestamp has changed
                const newContainerHTML = createImageContainerHTML(index, image, cacheBustedSrc, relativeTime, triggeredBy);
                if (container.length === 0) {
                    // Create new container if it doesn't exist
                    $('#gallery').append(newContainerHTML);
                    console.log(`Created new container for image: ${image.src}`);
                } else {
                    // Replace the existing container with the new HTML
                    container.replaceWith(newContainerHTML);
                    console.log(`Re-rendered container for image: ${image.src}`);
                }

                imageTimestamps[index] = data ? data.created : null; // Store the timestamp
            }

            function createImageContainerHTML(index, image, cacheBustedSrc, relativeTime, triggeredBy) {
                return `
                    <div class="image-container" id="image-container-${index}">
                        <img src="${cacheBustedSrc}" alt="${image.alt}">
                        <div class="image-title">${image.title}</div>
                        <div class="timestamp">Created: ${relativeTime}</div>
                        ${triggeredBy ? `<div class="triggered-by">Triggered by: ${triggeredBy}</div>` : ''}
                    </div>
                `;
            }

            function updateImages() {
                const requests = images.map((image, index) => {
                    const jsonFile = image.src.replace('.jpg', '.json');
                    return $.getJSON(jsonFile).then(
                        data => {
                            const currentTimestamp = imageTimestamps[index];
                            if (!currentTimestamp || currentTimestamp !== data.created) {
                                updateImageContainer(index, image, data);
                            } else {
                                // Update only the relative time if the timestamp hasn't changed
                                const relativeTime = getRelativeTime(data.created);
                                $(`#image-container-${index} .timestamp`).text(`Created: ${relativeTime}`);
                            }
                        },
                        () => updateImageContainer(index, image, null)
                    );
                });

                $.when(...requests).then(() => {
                    // Sort and append containers if needed
                    const sortedContainers = images.map((_, index) => $(`#image-container-${index}`));
                    $('#gallery').html(sortedContainers);
                });
            }

            // Initial load
            updateImages();

            // Set interval to update images every 2 seconds
            setInterval(updateImages, 2000);
        });
    </script>
</head>
<body>
    <h1>AI Halloween</h1>
    <h2>Recent Images</h2>
    <div id="gallery">
        <!-- Image containers will be dynamically added here by jQuery -->
    </div>
</body>
</html>
